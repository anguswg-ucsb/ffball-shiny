---
title: "Fantasy land"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-question-circle", href: "https://water.noaa.gov/about/nwm", align: right }
    theme: cerulean
    orientation: rows
    vertical_layout: fill
---

```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
library(shinyWidgets)
library(shinycustomloader)

library(nflfastR)
library(DT)
library(plotly)

library(ggplot2)
library(dplyr)
library(tidyr)
library(DT)
library(plotly)

source('helper.R')

# df1 <- load_data(2020)
```

```{r context="server"}

 # season <<- reactive({
     # season <- load_data(as.numeric(input$seasonDropdown))
 # })
# season <- reactiveValues()
season <<- reactive({
  dataset <- load_data(as.numeric(input$seasonDropdown))
})
```

Player stats {data-icon="fa-tint"}
====================================

Inputs {.sidebar}
-------------------------------------

### Filters
```{r}
# dqshiny::autocomplete_input("auto", "Search for a County:",
#                                 value = "",
#                                 max_options = 5,
#                                 options = list(season()$full_name))

selectInput("seasonDropdown",
            label = "Season", 
            choices = c("All", 2020:1999))

selectInput("positionDropdown",
            label = "Position", 
            choices = c("All", "QB", "RB", "WR", "TE"))

uiOutput("playerSelector")

# Input: Specification of range within an interval ----
sliderInput("weekRange", "Week",
                  min = 1, max = 16,
                  value = c(1, 16))

verbatimTextOutput("seasonDropdownText")

verbatimTextOutput("positionDropdownText")

verbatimTextOutput("playerSearchText")

verbatimTextOutput("weekRangeText")
```

```{r context = "server"}
# TESTING INPUTS + ACTION BUTTON REACTIVITY
seasonText <- eventReactive(input$submitButton, {
    paste0("Season: ", input$seasonDropdown)
  })

output$seasonDropdownText <- renderText({
   seasonText()
  })

positionText <- eventReactive(input$submitButton, {
    paste0("Position: ", input$positionDropdown)
  })
  
output$positionDropdownText <- renderText({
   positionText()
  })

playerText <- eventReactive(input$submitButton, {
    paste0("Player: ", input$playerSearch)
  })
  
output$playerSearchText <- renderText({
   playerText()
  })

weekRangeText <- eventReactive(input$submitButton, {
    paste0("Week: ", input$weekRange[1], input$weekRange[2])
  })
  
output$weekRangeText <- renderText({
   weekRangeText()
  })

```

### **Submit**
```{r}
shiny::actionButton("submitButton", label = "Enter", icon("search"))
```

Row
----------------------------------------
### Player plot
```{r}
plotlyOutput("playerGraph")
```

```{r context="server"}
playerData <- eventReactive(input$submitButton, {
  if(is.null(input$playerSearch)) {
    NULL
  } else {
    df <- season()
    df <- player_data(df, input$playerSearch, input$weekRange[1], input$weekRange[2])
    make_player_plot(df)
  }
})

output$playerGraph <- renderPlotly({
  playerData()
})
```

### Player Profile
```{r}
# htmlOutput("profilePic")
```

```{r context = "server"}
# headshotPic <- eventReactive(input$submitButton, {
#   if(is.null(input$playerSearch)) {
#     NULL
#   } else {
#     df <- season()
#     df <- player_data(df, input$playerSearch)
#     output$profilePic <- renderImage({
#         list(src = df$headshot_url,
#           contentType = 'image/png',
#           width = 224,
#           height = 136,
#           alt = "This is image alternate text")
#       })
#     }
# })
# output$profilePic <- renderImage({
#     list(src = ,
#      contentType = 'image/png',
#      width = 224,
#      height = 136,
#      alt = "This is image alternate text")
```

Row
----------------------------------------
### Data table
```{r}
DTOutput("seasonDT")
```

```{r context="server"}
output$playerSelector <- renderUI({
  df2 <- season()
   selectInput("playerSearch", "Choose name:", as.list(df2$full_name), multiple= TRUE, selectize = TRUE)
})

seasonData <- eventReactive(input$submitButton, {
    df <- season()
    if (input$positionDropdown != "All") {
          df <- df[df$position == input$positionDropdown,]
          }
    #select position, team, full_name to join with summarized df
        df2 <- df %>%
          select(3, 4, 42, 43)
        df2 <- unique(df2)
        df <- df %>%
            group_by(full_name) %>%
            summarise(across(6:39, sum))
        df <- left_join(df2, df, by = "full_name")
        df <- df %>%
          select(4, 1:3, 38, 37, 36, 5:35) %>%
          arrange(-fpts_hppr)
        
    # datatabale
      datatable(df, options = list(scrollX = TRUE, paging = TRUE, searching = TRUE))
  })

output$seasonDT <- renderDT({
   seasonData()
  })
# observeEvent(input$submitButton, {
#   season$df_data <- load_data(as.numeric(input$seasonDropdown))
#              })
```











```{r context = "server"}
# seasonData <- eventReactive(input$submitButton, {
#   make_dt(load_data(as.numeric(input$seasonDropdown)))
#   })
# 
# output$seasonDT <- renderDT({
#    seasonData()
#   })
# observeEvent(input$submitButton, {
#   season$df_data <<- load_data(as.numeric(input$seasonDropdown))
# })

# season & position inputs output data table
# seasonData <- eventReactive(input$submitButton, {
#   df <- season()
#     season$df_data <<- load_data(as.numeric(input$seasonDropdown))
#     
#       if (input$positionDropdown != "All") {
#           season <- season[season$position == input$positionDropdown,]
#       }
# 
#     #select position, team, full_name to join with summarized season
#     season2 <- season %>%
#       select(3, 4, 42, 43)
# 
#     season2 <- unique(season2)
# 
#     season <- season %>%
#         group_by(full_name) %>%
#         summarise(across(6:39, sum))
#     season <- left_join(season2, season, by = "full_name")
# 
#     season <- season %>%
#       select(4, 1:3, 38, 37, 36, 5:35) %>%
#       arrange(-fpts_hppr)
#       datatable(season, options = list(scrollX = TRUE, paging = TRUE, searching = TRUE))
#   })
# 
# output$seasonDT <- renderDT({
#    seasonData()
#   })

```





```{r}
# observe(
#     if(input$auto == ""){
#       NULL
#     } else {
#       FIP <<- input$auto
#       leafletProxy("covidMap") %>%
#         zoom_to_county(counties, FIP)
#       output$covidChart <- renderDygraph({ make_graph(covid19, FIP) })
#       output$covidTable <- renderDT({ make_table2(today, FIP) })
#       output$covidNewCases = renderPlotly({ daily_cases_graph(covid19, FIP) })
#       output$covidNewDeaths <- renderPlotly({ daily_deaths_graph(covid19, FIP) })
#       leafletProxy("covidMap2") %>%
#           zoom_to_county(counties, FIP)
#     })

```



